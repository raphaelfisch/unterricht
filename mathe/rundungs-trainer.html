<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rundungs-Trainer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Touch optimizations */
        button, .digit-box.clickable {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #fff;
            color: #000;
            padding: 20px;
            max-width: 750px;
            margin: 0 auto;
        }
        h1 { font-size: 1.2rem; font-weight: 500; margin-bottom: 20px; text-align: center; }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 24px;
            border-bottom: 1px solid #eee;
            padding-bottom: 16px;
        }
        .tab-btn {
            font-family: inherit;
            font-size: 0.95rem;
            padding: 8px 20px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
            border-radius: 3px;
        }
        .tab-btn:hover { background: #f5f5f5; }
        .tab-btn.active {
            background: #000;
            color: #fff;
            border-color: #000;
        }
        .tab-short { display: none; }
        .tab-full { display: inline; }

        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Score */
        .score-bar {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 20px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .streak-fire { color: #f59e0b; }

        /* Level/Mode-Auswahl */
        .level-select, .mode-select {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 24px;
        }
        .level-btn, .mode-btn {
            font-family: inherit;
            font-size: 0.85rem;
            padding: 6px 14px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
            border-radius: 3px;
        }
        .level-btn:hover, .mode-btn:hover { background: #f5f5f5; }
        .level-btn.active, .mode-btn.active {
            background: #000;
            color: #fff;
            border-color: #000;
        }

        /* Aufgabe */
        .task-area {
            text-align: center;
            margin-bottom: 24px;
            padding-top: 10px;
        }
        .instruction {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 55px;
        }
        .target-place {
            font-weight: 600;
            color: #000;
        }

        /* Zahlen-Anzeige */
        .number-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 0 32px;
        }
        .number-display {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 4px;
        }
        .label-row {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-top: 8px;
        }
        .digit-box {
            width: 64px;
            height: 88px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.8rem;
            font-weight: 500;
            border-radius: 8px;
            position: relative;
            background: #f9f9f9;
            border: 1px solid #e5e5e5;
        }
        .digit-box.target {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            color: #1d4ed8;
        }
        .digit-box.decision {
            background: #fce7f3;
            border: 2px solid #ec4899;
            color: #be185d;
        }
        .digit-box.correct {
            background: #dcfce7;
            border: 2px solid #22c55e;
            color: #16a34a;
        }
        .digit-box.wrong {
            background: #fef2f2;
            border: 2px solid #ef4444;
            color: #dc2626;
        }
        .digit-box.clickable {
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        @media (hover: hover) {
            .digit-box.clickable:hover {
                transform: scale(1.05);
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
        }
        .digit-box.clickable:active {
            transform: scale(0.98);
        }
        .digit-box.decimal {
            width: 24px;
            background: transparent;
            border: none;
            font-size: 2.8rem;
            cursor: default;
        }
        .digit-box.decimal:hover {
            transform: none;
            box-shadow: none;
        }
        .label-cell {
            width: 64px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.7rem;
            color: #999;
            line-height: 1.2;
        }
        .label-cell.decimal {
            width: 24px;
        }
        .arrow-indicator {
            position: absolute;
            top: -28px;
            font-size: 0.8rem;
            color: #3b82f6;
        }

        /* Legende */
        .legend {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin: 8px 0 24px;
            font-size: 0.85rem;
            color: #666;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-box {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }
        .legend-box.target {
            background: #dbeafe;
            border: 2px solid #3b82f6;
        }
        .legend-box.decision {
            background: #fce7f3;
            border: 2px solid #ec4899;
        }

        /* Eingabe */
        .input-area {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        .answer-input {
            font-family: inherit;
            font-size: 1.4rem;
            width: 160px;
            padding: 10px 16px;
            text-align: center;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            outline: none;
        }
        .answer-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .answer-input.correct {
            border-color: #22c55e;
            background: #f0fdf4;
        }
        .answer-input.wrong {
            border-color: #ef4444;
            background: #fef2f2;
            animation: shake 0.4s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }

        .check-btn {
            font-family: inherit;
            font-size: 0.95rem;
            padding: 10px 24px;
            background: #2563eb;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .check-btn:hover { background: #1d4ed8; }
        .check-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Feedback */
        .feedback {
            text-align: center;
            font-size: 1rem;
            min-height: 28px;
            margin-bottom: 20px;
        }
        .feedback.correct { color: #16a34a; }
        .feedback.wrong { color: #dc2626; }
        .correct-answer { font-weight: 600; }

        /* Buttons */
        .button-row {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .action-btn {
            font-family: inherit;
            font-size: 0.85rem;
            padding: 6px 14px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
            border-radius: 3px;
        }
        .action-btn:hover { background: #f5f5f5; }

        /* Hilfe */
        .help-section {
            margin-top: 32px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            text-align: center;
        }

        /* Popup */
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .popup-overlay.visible {
            display: flex;
        }
        .popup {
            background: #fff;
            border-radius: 8px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
            font-weight: 600;
        }
        .popup-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #666;
            padding: 0;
            line-height: 1;
        }
        .popup-close:hover {
            color: #000;
        }
        .popup-content {
            padding: 20px;
            font-size: 0.95rem;
            color: #444;
            line-height: 1.6;
        }
        .popup-content .rule-box {
            margin-top: 16px;
        }
        .rule-box {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 16px;
        }
        .rule {
            padding: 12px 20px;
            border-radius: 6px;
            text-align: center;
        }
        .rule.down {
            background: #fef3c7;
            border: 1px solid #fcd34d;
        }
        .rule.up {
            background: #dcfce7;
            border: 1px solid #86efac;
        }
        .rule-digits {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .rule.down .rule-digits { color: #b45309; }
        .rule.up .rule-digits { color: #16a34a; }

        /* ========== THEORIE TAB ========== */
        .theory-section {
            margin-bottom: 32px;
        }
        .theory-section h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: #000;
        }
        .theory-section p {
            font-size: 0.95rem;
            line-height: 1.7;
            color: #444;
            margin-bottom: 12px;
        }
        .theory-example {
            background: #f9f9f9;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 20px;
            margin: 16px 0;
        }
        .theory-example-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #000;
        }
        .theory-number {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin: 20px 0;
        }
        .theory-digit {
            width: 48px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 500;
            border-radius: 6px;
            background: #f9f9f9;
            border: 1px solid #e5e5e5;
        }
        .theory-digit.target {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            color: #1d4ed8;
        }
        .theory-digit.decision {
            background: #fce7f3;
            border: 2px solid #ec4899;
            color: #be185d;
        }
        .theory-digit.decimal {
            width: 20px;
            background: transparent;
            border: none;
        }
        .theory-labels {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-top: 8px;
        }
        .theory-label {
            width: 48px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.65rem;
            color: #999;
            line-height: 1.2;
        }
        .theory-label.decimal {
            width: 20px;
        }
        .theory-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin: 12px 0;
            padding: 12px;
            background: #fff;
            border-radius: 6px;
        }
        .theory-step-num {
            width: 24px;
            height: 24px;
            background: #000;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            flex-shrink: 0;
        }
        .theory-step-text {
            font-size: 0.9rem;
            color: #444;
            line-height: 1.5;
        }
        .highlight-blue { color: #1d4ed8; font-weight: 600; }
        .highlight-pink { color: #be185d; font-weight: 600; }
        .highlight-green { color: #16a34a; font-weight: 600; }

        /* Theory interactive */
        .theory-interactive {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .theory-select-row {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .theory-select-row span {
            font-weight: 500;
            color: #444;
        }
        .theory-level-btns {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .theory-level-btn {
            font-family: inherit;
            font-size: 0.8rem;
            padding: 5px 10px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
            border-radius: 3px;
        }
        .theory-level-btn:hover { background: #f5f5f5; }
        .theory-level-btn.active {
            background: #000;
            color: #fff;
            border-color: #000;
        }
        .theory-checkboxes {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 8px;
        }
        .theory-checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .theory-checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Option checkbox */
        .option-checkbox {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .option-checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            color: #666;
        }
        .option-checkbox-label input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* Exam styles */
        .exam-screen {
            text-align: center;
        }
        .exam-info {
            padding: 40px 20px;
        }
        .exam-info h2 {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .exam-info p {
            font-size: 1rem;
            color: #444;
            margin-bottom: 8px;
        }
        .exam-note {
            font-size: 0.9rem !important;
            color: #888 !important;
            margin-top: 16px !important;
            margin-bottom: 24px !important;
        }
        .start-btn {
            font-family: inherit;
            font-size: 1rem;
            padding: 12px 32px;
            background: #2563eb;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 16px;
        }
        .start-btn:hover { background: #1d4ed8; }

        .exam-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .exam-progress {
            font-size: 1rem;
            color: #444;
        }
        .exam-timer {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2563eb;
            font-variant-numeric: tabular-nums;
        }
        .exam-timer.warning {
            color: #dc2626;
        }

        .exam-results-content {
            padding: 40px 20px;
        }
        .exam-results-content h2 {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 24px;
        }
        .exam-score {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
        .exam-percent {
            font-size: 2.5rem;
            font-weight: 600;
            color: #2563eb;
            margin-bottom: 32px;
        }
        .exam-results-content h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: #444;
        }
        .exam-wrong-list {
            text-align: left;
            max-width: 400px;
            margin: 0 auto 24px;
        }
        .exam-wrong-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .exam-wrong-item .task {
            color: #666;
            margin-bottom: 4px;
        }
        .exam-wrong-item .answers {
            display: flex;
            gap: 16px;
        }
        .exam-wrong-item .your-answer {
            color: #dc2626;
        }
        .exam-wrong-item .correct-answer {
            color: #16a34a;
        }

        /* Responsive */
        /* Tablet */
        @media (max-width: 768px) {
            body { padding: 16px; }
            .tab-nav { gap: 6px; }
            .tab-btn { font-size: 0.85rem; padding: 8px 14px; }
            .digit-box {
                width: 56px;
                height: 78px;
                font-size: 2.4rem;
            }
            .digit-box.decimal { width: 20px; }
            .label-cell { width: 56px; font-size: 0.65rem; }
            .label-cell.decimal { width: 20px; }
            .theory-section h2 { font-size: 1rem; }
            .theory-section p { font-size: 0.9rem; }
        }

        /* Mobile */
        @media (max-width: 500px) {
            body { padding: 12px; }
            h1 { font-size: 1.1rem; margin-bottom: 16px; }
            .tab-nav { 
                gap: 4px; 
                padding-bottom: 12px;
                margin-bottom: 16px;
            }
            .tab-btn { 
                font-size: 0.75rem; 
                padding: 8px 6px;
                flex: 1;
                text-align: center;
            }
            .tab-short { display: inline; }
            .tab-full { display: none; }
            .score-bar {
                font-size: 0.85rem;
                padding: 8px 0;
                margin-bottom: 16px;
            }
            .digit-box {
                width: 44px;
                height: 62px;
                font-size: 1.9rem;
            }
            .digit-box.decimal { width: 14px; font-size: 1.9rem; }
            .label-cell { width: 44px; font-size: 0.5rem; height: 28px; }
            .label-cell.decimal { width: 14px; }
            .arrow-indicator { font-size: 0.65rem; top: -24px; }
            .legend { flex-direction: column; gap: 8px; align-items: center; }
            .instruction { font-size: 1rem; margin-bottom: 40px; }
            .input-area { flex-direction: column; gap: 10px; }
            .answer-input { 
                width: 100%; 
                max-width: 200px;
                font-size: 1.3rem; 
                padding: 12px 16px;
            }
            .check-btn {
                width: 100%;
                max-width: 200px;
                padding: 12px 24px;
            }
            .level-select, .mode-select { gap: 6px; }
            .level-btn, .mode-btn { 
                font-size: 0.7rem; 
                padding: 6px 8px;
            }
            .button-row { gap: 8px; }
            .action-btn { 
                font-size: 0.8rem; 
                padding: 8px 12px;
            }
            .rule-box { flex-direction: column; gap: 10px; }
            .rule { padding: 10px 16px; }
            .rule-digits { font-size: 1.1rem; }
            .theory-digit { width: 36px; height: 48px; font-size: 1.5rem; }
            .theory-digit.decimal { width: 14px; }
            .theory-label { width: 36px; font-size: 0.5rem; height: 24px; }
            .theory-label.decimal { width: 14px; }
            .theory-section { margin-bottom: 24px; }
            .theory-section h2 { font-size: 1rem; margin-bottom: 12px; }
            .theory-section p { font-size: 0.9rem; }
            .theory-example { padding: 16px; }
            .theory-step { padding: 10px; gap: 10px; }
            .theory-step-num { width: 22px; height: 22px; font-size: 0.75rem; }
            .theory-step-text { font-size: 0.85rem; }
            .theory-select-row { flex-direction: column; gap: 8px; }
            .theory-level-btn { font-size: 0.7rem; padding: 5px 8px; }
            .theory-checkbox-label { font-size: 0.8rem; gap: 8px; }
            .theory-checkbox-label input[type="checkbox"] { width: 16px; height: 16px; }
            .option-checkbox { gap: 16px; }
            .option-checkbox-label { font-size: 0.8rem; }
            .popup { width: 95%; }
            .popup-header { padding: 14px 16px; }
            .popup-content { padding: 16px; }
            .help-section { margin-top: 24px; padding-top: 16px; }
            .exam-info { padding: 24px 16px; }
            .exam-info h2 { font-size: 1.2rem; }
            .exam-info p { font-size: 0.9rem; }
            .exam-header { padding: 12px 0; }
            .exam-progress { font-size: 0.9rem; }
            .exam-timer { font-size: 1.1rem; }
            .exam-results-content { padding: 24px 16px; }
            .exam-score { font-size: 1.2rem; }
            .exam-percent { font-size: 2rem; }
            .exam-wrong-item { font-size: 0.85rem; }
            .exam-wrong-item .answers { flex-direction: column; gap: 4px; }
        }

        /* Very small phones */
        @media (max-width: 360px) {
            .tab-btn { font-size: 0.7rem; padding: 6px 6px; }
            .digit-box {
                width: 36px;
                height: 52px;
                font-size: 1.6rem;
            }
            .digit-box.decimal { width: 12px; }
            .label-cell { width: 36px; font-size: 0.45rem; }
            .label-cell.decimal { width: 12px; }
            .level-btn, .mode-btn { font-size: 0.65rem; padding: 5px 6px; }
            .theory-digit { width: 30px; height: 42px; font-size: 1.3rem; }
            .theory-digit.decimal { width: 12px; }
            .theory-label { width: 30px; font-size: 0.45rem; }
            .option-checkbox-label { font-size: 0.75rem; }
        }
    </style>
</head>
<body>
    <h1>Rundungs-Trainer</h1>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" data-tab="theory">Theorie</button>
        <button class="tab-btn" data-tab="identify"><span class="tab-full">Stellen erkennen</span><span class="tab-short">Stellen</span></button>
        <button class="tab-btn" data-tab="practice">Ãœben</button>
        <button class="tab-btn" data-tab="exam">PrÃ¼fung</button>
    </div>

    <!-- ========== TAB 1: THEORIE ========== -->
    <div id="tab-theory" class="tab-content active">
        <div class="theory-section">
            <h2>Stellenwerte</h2>
            <p>Jede Ziffer in einer Zahl hat einen bestimmten Stellenwert. Die Position bestimmt, wie viel die Ziffer wert ist:</p>
            
            <div class="theory-example">
                <div class="theory-number">
                    <div class="theory-digit">3</div>
                    <div class="theory-digit">8</div>
                    <div class="theory-digit">5</div>
                    <div class="theory-digit decimal">,</div>
                    <div class="theory-digit">2</div>
                    <div class="theory-digit">7</div>
                    <div class="theory-digit">4</div>
                    <div class="theory-digit">5</div>
                </div>
                <div class="theory-labels">
                    <div class="theory-label">Hunderter</div>
                    <div class="theory-label">Zehner</div>
                    <div class="theory-label">Einer</div>
                    <div class="theory-label decimal"></div>
                    <div class="theory-label">Zehntel</div>
                    <div class="theory-label">Hundert-<br>stel</div>
                    <div class="theory-label">Tausend-<br>stel</div>
                    <div class="theory-label">Zehn-<br>tausendstel</div>
                </div>
            </div>
        </div>

        <div class="theory-section">
            <h2>Was bedeutet Runden?</h2>
            <p>Beim Runden vereinfachen wir eine Zahl, indem wir sie auf eine bestimmte Stelle kÃ¼rzen. DafÃ¼r brauchen wir zwei wichtige Stellen:</p>
            
            <div class="theory-example">
                <div class="theory-interactive">
                    <div class="theory-select-row">
                        <span>Runden auf:</span>
                        <div class="theory-level-btns">
                            <button class="theory-level-btn" data-theory-level="zehner">Zehner</button>
                            <button class="theory-level-btn active" data-theory-level="ganzzahl">Ganzzahl</button>
                            <button class="theory-level-btn" data-theory-level="zehntel">Zehntel</button>
                            <button class="theory-level-btn" data-theory-level="hundertstel">Hundertstel</button>
                            <button class="theory-level-btn" data-theory-level="tausendstel">Tausendstel</button>
                        </div>
                    </div>
                    
                    <div class="theory-number" id="theory-interactive-number">
                        <div class="theory-digit" data-idx="0">3</div>
                        <div class="theory-digit" data-idx="1">8</div>
                        <div class="theory-digit" data-idx="2">5</div>
                        <div class="theory-digit decimal">,</div>
                        <div class="theory-digit" data-idx="4">2</div>
                        <div class="theory-digit" data-idx="5">7</div>
                        <div class="theory-digit" data-idx="6">4</div>
                        <div class="theory-digit" data-idx="7">5</div>
                    </div>
                    <div class="theory-labels" id="theory-interactive-labels">
                        <div class="theory-label">Hunderter</div>
                        <div class="theory-label">Zehner</div>
                        <div class="theory-label">Einer</div>
                        <div class="theory-label decimal"></div>
                        <div class="theory-label">Zehntel</div>
                        <div class="theory-label">Hundert-<br>stel</div>
                        <div class="theory-label">Tausend-<br>stel</div>
                        <div class="theory-label">Zehn-<br>tausendstel</div>
                    </div>
                    
                    <div class="theory-checkboxes">
                        <label class="theory-checkbox-label">
                            <input type="checkbox" id="show-target">
                            <div class="legend-box target"></div>
                            <span><strong>Zielstelle</strong> â€“ die Stelle, auf die wir runden</span>
                        </label>
                        <label class="theory-checkbox-label">
                            <input type="checkbox" id="show-decision">
                            <div class="legend-box decision"></div>
                            <span><strong>Entscheidungsziffer</strong> â€“ die Stelle rechts daneben, die entscheidet</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="theory-section">
            <h2>Die Rundungsregel</h2>
            <p>Schau auf die <strong>Entscheidungsziffer</strong> und entscheide:</p>
            
            <div class="rule-box" style="margin: 20px 0;">
                <div class="rule down">
                    <div class="rule-digits">0, 1, 2, 3, 4</div>
                    <div>â†’ Abrunden</div>
                    <div style="font-size: 0.85rem; color: #666; margin-top: 4px;">Zielstelle bleibt gleich</div>
                </div>
                <div class="rule up">
                    <div class="rule-digits">5, 6, 7, 8, 9</div>
                    <div>â†’ Aufrunden</div>
                    <div style="font-size: 0.85rem; color: #666; margin-top: 4px;">Zielstelle wird um 1 erhÃ¶ht</div>
                </div>
            </div>
        </div>

        <div class="theory-section">
            <h2>Beispiel: Runde 385,2745 auf Zehntel</h2>
            <p>"Auf Zehntel" bedeutet dasselbe wie "auf 1 Stelle nach dem Komma".</p>
            
            <div class="theory-example">
                <div class="theory-number">
                    <div class="theory-digit">3</div>
                    <div class="theory-digit">8</div>
                    <div class="theory-digit">5</div>
                    <div class="theory-digit decimal">,</div>
                    <div class="theory-digit target">2</div>
                    <div class="theory-digit decision">7</div>
                    <div class="theory-digit">4</div>
                    <div class="theory-digit">5</div>
                </div>
                <div class="theory-labels">
                    <div class="theory-label"></div>
                    <div class="theory-label"></div>
                    <div class="theory-label"></div>
                    <div class="theory-label decimal"></div>
                    <div class="theory-label">Ziel</div>
                    <div class="theory-label">Entscheid.</div>
                    <div class="theory-label"></div>
                    <div class="theory-label"></div>
                </div>
                
                <div class="theory-step">
                    <div class="theory-step-num">1</div>
                    <div class="theory-step-text">Finde die <span class="highlight-blue">Zielstelle</span>: Zehntel = erste Stelle nach dem Komma = <span class="highlight-blue">2</span></div>
                </div>
                <div class="theory-step">
                    <div class="theory-step-num">2</div>
                    <div class="theory-step-text">Finde die <span class="highlight-pink">Entscheidungsziffer</span>: Stelle rechts daneben = <span class="highlight-pink">7</span></div>
                </div>
                <div class="theory-step">
                    <div class="theory-step-num">3</div>
                    <div class="theory-step-text">Wende die Regel an: <span class="highlight-pink">7</span> â‰¥ 5 â†’ <span class="highlight-green">Aufrunden!</span></div>
                </div>
                <div class="theory-step">
                    <div class="theory-step-num">4</div>
                    <div class="theory-step-text">Ergebnis: 385,<span class="highlight-blue">2</span>745 wird zu <strong>385,3</strong></div>
                </div>
            </div>
        </div>

        <div class="theory-section">
            <h2>Alternative Schreibweisen</h2>
            <p>Die gleiche Rundung kann unterschiedlich formuliert werden:</p>
            
            <div class="theory-example">
                <table style="width: 100%; font-size: 0.9rem; border-collapse: collapse;">
                    <tr style="border-bottom: 1px solid #e5e5e5;">
                        <td style="padding: 8px 0;"><strong>auf Zehntel</strong></td>
                        <td style="padding: 8px 0;">= auf 1 Stelle nach dem Komma</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #e5e5e5;">
                        <td style="padding: 8px 0;"><strong>auf Hundertstel</strong></td>
                        <td style="padding: 8px 0;">= auf 2 Stellen nach dem Komma</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 0;"><strong>auf Tausendstel</strong></td>
                        <td style="padding: 8px 0;">= auf 3 Stellen nach dem Komma</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <!-- ========== TAB 2: STELLEN ERKENNEN ========== -->
    <div id="tab-identify" class="tab-content">
        <div class="score-bar">
            <div>Punkte: <span id="identify-score">0</span></div>
            <div>
                <span class="streak-fire" id="identify-streak-display" style="display: none;">ðŸ”¥</span>
                Serie: <span id="identify-streak">0</span>
            </div>
        </div>

        <div class="mode-select">
            <button class="mode-btn active" data-mode="target">Zielstelle</button>
            <button class="mode-btn" data-mode="decision">Entscheidungsziffer</button>
            <button class="mode-btn" data-mode="both">Beides</button>
        </div>

        <div class="option-checkbox">
            <label class="option-checkbox-label">
                <input type="checkbox" id="show-labels" checked>
                <span>Stellenwerte anzeigen</span>
            </label>
        </div>

        <div class="task-area">
            <p class="instruction" id="identify-instruction">Klicke auf die <span class="target-place">Zielstelle</span> beim Runden auf <span class="target-place" id="identify-target">Zehntel</span></p>
            <div class="number-wrapper">
                <div class="number-display" id="identify-number-display"></div>
                <div class="label-row" id="identify-label-row"></div>
            </div>
        </div>

        <div class="feedback" id="identify-feedback"></div>

        <div class="button-row">
            <button class="action-btn" id="identify-skip-btn">Ãœberspringen</button>
            <button class="action-btn" id="identify-next-btn" style="display: none;">NÃ¤chste Aufgabe</button>
        </div>
    </div>

    <!-- ========== TAB 3: ÃœBEN ========== -->
    <div id="tab-practice" class="tab-content">
        <div class="score-bar">
            <div>Punkte: <span id="practice-score">0</span></div>
            <div>
                <span class="streak-fire" id="practice-streak-display" style="display: none;">ðŸ”¥</span>
                Serie: <span id="practice-streak">0</span>
            </div>
        </div>

        <div class="level-select">
            <button class="level-btn" data-level="zehner">Zehner</button>
            <button class="level-btn active" data-level="ganzzahl">Ganzzahl</button>
            <button class="level-btn" data-level="zehntel">Zehntel</button>
            <button class="level-btn" data-level="hundertstel">Hundertstel</button>
            <button class="level-btn" data-level="tausendstel">Tausendstel</button>
            <button class="level-btn" data-level="gemischt">Gemischt</button>
        </div>

        <div class="option-checkbox">
            <label class="option-checkbox-label">
                <input type="checkbox" id="practice-show-markers">
                <span>Markierungen anzeigen</span>
            </label>
            <label class="option-checkbox-label">
                <input type="checkbox" id="practice-show-labels" checked>
                <span>Stellenwerte anzeigen</span>
            </label>
        </div>

        <div class="task-area">
            <p class="instruction">Runde auf <span class="target-place" id="practice-target-place">Ganzzahl</span></p>
            <div class="number-wrapper">
                <div class="number-display" id="practice-number-display"></div>
                <div class="label-row" id="practice-label-row"></div>
            </div>
        </div>

        <div class="legend" id="practice-legend" style="display: none;">
            <div class="legend-item">
                <div class="legend-box target"></div>
                <span>Zielstelle</span>
            </div>
            <div class="legend-item">
                <div class="legend-box decision"></div>
                <span>Entscheidungsziffer</span>
            </div>
        </div>

        <div class="input-area">
            <input type="text" class="answer-input" id="practice-answer" placeholder="?" autocomplete="off" inputmode="decimal">
            <button class="check-btn" id="practice-check-btn">PrÃ¼fen</button>
        </div>

        <div class="feedback" id="practice-feedback"></div>

        <div class="button-row">
            <button class="action-btn" id="practice-skip-btn">Ãœberspringen</button>
            <button class="action-btn" id="practice-next-btn" style="display: none;">NÃ¤chste Aufgabe</button>
        </div>

        <div class="help-section">
            <button class="action-btn" id="help-btn">ðŸ’¡ Rundungsregeln</button>
        </div>

        <!-- Popup -->
        <div class="popup-overlay" id="popup-overlay">
            <div class="popup">
                <div class="popup-header">
                    <span>ðŸ’¡ Rundungsregeln</span>
                    <button class="popup-close" id="popup-close">âœ•</button>
                </div>
                <div class="popup-content">
                    <p>Schau auf die <strong>Entscheidungsziffer</strong> (rechts neben der Zielstelle):</p>
                    <div class="rule-box">
                        <div class="rule down">
                            <div class="rule-digits">0, 1, 2, 3, 4</div>
                            <div>â†’ Abrunden</div>
                        </div>
                        <div class="rule up">
                            <div class="rule-digits">5, 6, 7, 8, 9</div>
                            <div>â†’ Aufrunden</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== TAB 4: PRÃœFUNG ========== -->
    <div id="tab-exam" class="tab-content">
        <!-- Start screen -->
        <div id="exam-start" class="exam-screen">
            <div class="exam-info">
                <h2>PrÃ¼fungsmodus</h2>
                <p>12 Aufgaben aus allen Schwierigkeitsstufen</p>
                <p>Zeitlimit: 2 Minuten</p>
                <p class="exam-note">Keine Hilfen, kein Feedback wÃ¤hrend der PrÃ¼fung.</p>
                <button class="start-btn" id="exam-start-btn">PrÃ¼fung starten</button>
            </div>
        </div>

        <!-- Exam screen -->
        <div id="exam-active" class="exam-screen" style="display: none;">
            <div class="exam-header">
                <div class="exam-progress">Aufgabe <span id="exam-current">1</span> / 12</div>
                <div class="exam-timer" id="exam-timer">2:00</div>
            </div>

            <div class="task-area">
                <p class="instruction">Runde auf <span class="target-place" id="exam-target-place">Ganzzahl</span></p>
                <div class="number-wrapper">
                    <div class="number-display" id="exam-number-display"></div>
                </div>
            </div>

            <div class="input-area">
                <input type="text" class="answer-input" id="exam-answer" placeholder="?" autocomplete="off" inputmode="decimal">
                <button class="check-btn" id="exam-next-btn">Weiter</button>
            </div>
        </div>

        <!-- Results screen -->
        <div id="exam-results" class="exam-screen" style="display: none;">
            <div class="exam-results-content">
                <h2>Ergebnis</h2>
                <div class="exam-score">
                    <span id="exam-correct">0</span> / 12 richtig
                </div>
                <div class="exam-percent" id="exam-percent">0%</div>
                
                <div id="exam-wrong-section" style="display: none;">
                    <h3>Falsche Antworten:</h3>
                    <div id="exam-wrong-list" class="exam-wrong-list"></div>
                </div>
                
                <button class="start-btn" id="exam-restart-btn">Neue PrÃ¼fung</button>
            </div>
        </div>
    </div>

    <script>
        // ========== GEMEINSAME KONFIGURATION ==========
        const levels = {
            zehner: {
                name: 'Zehner',
                altNames: ['Zehner'],
                generate: () => Math.floor(Math.random() * 900) + 100,
                round: (n) => Math.round(n / 10) * 10,
                decimals: 0
            },
            ganzzahl: {
                name: 'Ganzzahl',
                altNames: ['Ganzzahl'],
                generate: () => {
                    const int = Math.floor(Math.random() * 900) + 100;
                    const dec = Math.floor(Math.random() * 100);
                    return parseFloat(`${int}.${dec.toString().padStart(2, '0')}`);
                },
                round: (n) => Math.round(n),
                decimals: 0
            },
            zehntel: {
                name: 'Zehntel',
                altNames: ['Zehntel', '1 Stelle nach dem Komma'],
                generate: () => {
                    const int = Math.floor(Math.random() * 90) + 10;
                    const dec = Math.floor(Math.random() * 1000);
                    return parseFloat(`${int}.${dec.toString().padStart(3, '0')}`);
                },
                round: (n) => Math.round(n * 10) / 10,
                decimals: 1
            },
            hundertstel: {
                name: 'Hundertstel',
                altNames: ['Hundertstel', '2 Stellen nach dem Komma'],
                generate: () => {
                    const int = Math.floor(Math.random() * 90) + 10;
                    const dec = Math.floor(Math.random() * 10000);
                    return parseFloat(`${int}.${dec.toString().padStart(4, '0')}`);
                },
                round: (n) => Math.round(n * 100) / 100,
                decimals: 2
            },
            tausendstel: {
                name: 'Tausendstel',
                altNames: ['Tausendstel', '3 Stellen nach dem Komma'],
                generate: () => {
                    const int = Math.floor(Math.random() * 90) + 10;
                    const dec = Math.floor(Math.random() * 100000);
                    return parseFloat(`${int}.${dec.toString().padStart(5, '0')}`);
                },
                round: (n) => Math.round(n * 1000) / 1000,
                decimals: 3
            }
        };

        function getRandomLevel() {
            const options = ['zehner', 'ganzzahl', 'zehntel', 'hundertstel', 'tausendstel'];
            return options[Math.floor(Math.random() * options.length)];
        }

        function getRandomAltName(level) {
            const names = levels[level].altNames;
            return names[Math.floor(Math.random() * names.length)];
        }

        function getTargetAndDecisionIndex(level, intLength) {
            let targetIdx, decisionIdx;
            if (level === 'ganzzahl') {
                targetIdx = intLength - 1;
                decisionIdx = intLength + 1;
            } else if (level === 'zehntel') {
                targetIdx = intLength + 1;
                decisionIdx = intLength + 2;
            } else if (level === 'hundertstel') {
                targetIdx = intLength + 2;
                decisionIdx = intLength + 3;
            } else if (level === 'tausendstel') {
                targetIdx = intLength + 3;
                decisionIdx = intLength + 4;
            } else if (level === 'zehner') {
                targetIdx = intLength - 2;
                decisionIdx = intLength - 1;
            }
            return { targetIdx, decisionIdx };
        }

        // ========== THEORY INTERACTIVE ==========
        const theoryLevelBtns = document.querySelectorAll('.theory-level-btn');
        const theoryNumber = document.getElementById('theory-interactive-number');
        const showTargetCheckbox = document.getElementById('show-target');
        const showDecisionCheckbox = document.getElementById('show-decision');
        let currentTheoryLevel = 'ganzzahl';

        function updateTheoryDisplay() {
            // For the number 385,2745: indices are 0,1,2 (int), 3 (decimal), 4,5,6,7 (dec)
            const intLength = 3; // 385
            const { targetIdx, decisionIdx } = getTargetAndDecisionIndex(currentTheoryLevel, intLength);
            
            const digits = theoryNumber.querySelectorAll('.theory-digit:not(.decimal)');
            digits.forEach((digit, i) => {
                // Map display index to actual index (accounting for decimal position)
                const idx = i < 3 ? i : i + 1;
                digit.classList.remove('target', 'decision');
                
                if (showTargetCheckbox.checked && idx === targetIdx) {
                    digit.classList.add('target');
                }
                if (showDecisionCheckbox.checked && idx === decisionIdx) {
                    digit.classList.add('decision');
                }
            });
        }

        theoryLevelBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                theoryLevelBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentTheoryLevel = btn.dataset.theoryLevel;
                updateTheoryDisplay();
            });
        });

        showTargetCheckbox.addEventListener('change', updateTheoryDisplay);
        showDecisionCheckbox.addEventListener('change', updateTheoryDisplay);

        // Initialize
        updateTheoryDisplay();

        // ========== TAB NAVIGATION ==========
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                
                tabBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `tab-${tab}`) {
                        content.classList.add('active');
                    }
                });

                // Initialize tab if needed
                if (tab === 'identify' && !identifyState.initialized) {
                    generateIdentifyTask();
                    identifyState.initialized = true;
                }
                if (tab === 'practice' && !practiceState.initialized) {
                    generatePracticeTask();
                    practiceState.initialized = true;
                }
            });
        });

        // ========== TAB 2: STELLEN ERKENNEN ==========
        let identifyState = {
            score: 0,
            streak: 0,
            currentNumber: 0,
            currentLevel: 'zehntel',
            mode: 'target', // 'target', 'decision', 'both'
            phase: 'target', // for 'both' mode: 'target' then 'decision'
            targetIdx: -1,
            decisionIdx: -1,
            answered: false,
            initialized: false
        };

        const identifyNumberDisplay = document.getElementById('identify-number-display');
        const identifyLabelRow = document.getElementById('identify-label-row');
        const identifyInstruction = document.getElementById('identify-instruction');
        const identifyTarget = document.getElementById('identify-target');
        const identifyFeedback = document.getElementById('identify-feedback');
        const identifyScoreDisplay = document.getElementById('identify-score');
        const identifyStreakDisplay = document.getElementById('identify-streak');
        const identifyStreakFire = document.getElementById('identify-streak-display');
        const identifySkipBtn = document.getElementById('identify-skip-btn');
        const identifyNextBtn = document.getElementById('identify-next-btn');
        const modeBtns = document.querySelectorAll('.mode-btn');
        const showLabelsCheckbox = document.getElementById('show-labels');

        modeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                modeBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                identifyState.mode = btn.dataset.mode;
                identifyState.streak = 0;
                identifyStreakFire.style.display = 'none';
                updateIdentifyDisplay();
                generateIdentifyTask();
            });
        });

        showLabelsCheckbox.addEventListener('change', () => {
            identifyLabelRow.style.display = showLabelsCheckbox.checked ? 'flex' : 'none';
        });

        function displayIdentifyNumber(number, level, clickable = true) {
            identifyNumberDisplay.innerHTML = '';
            identifyLabelRow.innerHTML = '';
            
            const numStr = number.toString();
            const parts = numStr.split('.');
            const intPart = parts[0];
            const decPart = parts[1] || '';
            
            const labels = ['Hunderter', 'Zehner', 'Einer', '', 'Zehntel', 'Hundertstel', 'Tausendstel', 'Zehn-<br>tausendstel', 'Hundert-<br>tausendstel'];
            
            const allDigits = [];
            for (let i = 0; i < intPart.length; i++) {
                allDigits.push({
                    digit: intPart[i],
                    label: labels[3 - intPart.length + i] || ''
                });
            }
            if (decPart) {
                allDigits.push({ digit: ',', isDecimal: true, label: '' });
                for (let i = 0; i < decPart.length; i++) {
                    allDigits.push({
                        digit: decPart[i],
                        label: labels[4 + i] || ''
                    });
                }
            }

            const { targetIdx, decisionIdx } = getTargetAndDecisionIndex(level, intPart.length);
            identifyState.targetIdx = targetIdx;
            identifyState.decisionIdx = decisionIdx;

            allDigits.forEach((item, idx) => {
                const box = document.createElement('div');
                box.className = 'digit-box';
                
                if (item.isDecimal) {
                    box.classList.add('decimal');
                    box.textContent = ',';
                } else {
                    box.textContent = item.digit;
                    
                    if (clickable) {
                        box.classList.add('clickable');
                        box.addEventListener('click', () => handleIdentifyClick(idx, box));
                    }
                }
                
                identifyNumberDisplay.appendChild(box);
                
                const labelCell = document.createElement('div');
                labelCell.className = 'label-cell';
                if (item.isDecimal) {
                    labelCell.classList.add('decimal');
                }
                labelCell.innerHTML = item.label;
                identifyLabelRow.appendChild(labelCell);
            });
        }

        function handleIdentifyClick(idx, box) {
            if (identifyState.answered) return;

            const expectedIdx = identifyState.phase === 'target' ? identifyState.targetIdx : identifyState.decisionIdx;
            const isCorrect = idx === expectedIdx;

            // Remove clickable from all
            document.querySelectorAll('#identify-number-display .digit-box.clickable').forEach(b => {
                b.classList.remove('clickable');
            });

            if (isCorrect) {
                box.classList.add(identifyState.phase === 'target' ? 'target' : 'decision');
                
                if (identifyState.mode === 'both' && identifyState.phase === 'target') {
                    // Move to decision phase
                    identifyState.phase = 'decision';
                    identifyFeedback.textContent = 'Richtig! Jetzt klicke auf die Entscheidungsziffer.';
                    identifyFeedback.className = 'feedback correct';
                    
                    // Re-enable clicking
                    setTimeout(() => {
                        document.querySelectorAll('#identify-number-display .digit-box:not(.decimal):not(.target)').forEach(b => {
                            b.classList.add('clickable');
                            b.addEventListener('click', function handler() {
                                const newIdx = Array.from(identifyNumberDisplay.children).indexOf(b);
                                handleIdentifyClick(newIdx, b);
                                b.removeEventListener('click', handler);
                            });
                        });
                        updateIdentifyInstruction();
                    }, 300);
                    return;
                }

                identifyState.streak++;
                const bonus = identifyState.streak >= 3 ? identifyState.streak : 0;
                identifyState.score += 10 + bonus;
                
                let msg = ['Richtig!', 'Super!', 'Perfekt!', 'Genau!'][Math.floor(Math.random() * 4)];
                if (identifyState.streak >= 3) {
                    msg += ` (+${bonus} Bonus)`;
                }
                identifyFeedback.textContent = msg;
                identifyFeedback.className = 'feedback correct';
                identifyStreakFire.style.display = identifyState.streak >= 3 ? 'inline' : 'none';
                
                identifyState.answered = true;
                identifySkipBtn.style.display = 'none';
                identifyNextBtn.style.display = 'inline-block';
                
                // Auto-advance after 2 seconds
                setTimeout(() => {
                    if (identifyState.answered) {
                        generateIdentifyTask();
                    }
                }, 2000);
            } else {
                box.classList.add('wrong');
                identifyState.streak = 0;
                identifyStreakFire.style.display = 'none';
                
                // Show correct answer
                const correctBox = identifyNumberDisplay.children[expectedIdx];
                correctBox.classList.add(identifyState.phase === 'target' ? 'target' : 'decision');
                
                identifyFeedback.textContent = 'Leider falsch. Die richtige Stelle ist markiert.';
                identifyFeedback.className = 'feedback wrong';
                
                identifyState.answered = true;
                identifySkipBtn.style.display = 'none';
                identifyNextBtn.style.display = 'inline-block';
            }

            updateIdentifyDisplay();
        }

        function updateIdentifyInstruction() {
            const stellen = identifyState.phase === 'target' ? 'Zielstelle' : 'Entscheidungsziffer';
            identifyInstruction.innerHTML = `Klicke auf die <span class="target-place">${stellen}</span> beim Runden auf <span class="target-place">${identifyTarget.textContent}</span>`;
        }

        function generateIdentifyTask() {
            identifyState.answered = false;
            identifyState.phase = (identifyState.mode === 'both' || identifyState.mode === 'target') ? 'target' : 'decision';
            identifyFeedback.textContent = '';
            identifyFeedback.className = 'feedback';
            identifySkipBtn.style.display = 'inline-block';
            identifyNextBtn.style.display = 'none';

            // Random level
            identifyState.currentLevel = getRandomLevel();
            const levelConfig = levels[identifyState.currentLevel];
            identifyState.currentNumber = levelConfig.generate();
            
            // Random formulation
            const displayName = getRandomAltName(identifyState.currentLevel);
            identifyTarget.textContent = displayName;
            
            updateIdentifyInstruction();
            displayIdentifyNumber(identifyState.currentNumber, identifyState.currentLevel, true);
            identifyLabelRow.style.display = showLabelsCheckbox.checked ? 'flex' : 'none';
        }

        function updateIdentifyDisplay() {
            identifyScoreDisplay.textContent = identifyState.score;
            identifyStreakDisplay.textContent = identifyState.streak;
        }

        identifySkipBtn.addEventListener('click', () => {
            identifyState.streak = 0;
            identifyStreakFire.style.display = 'none';
            updateIdentifyDisplay();
            generateIdentifyTask();
        });

        identifyNextBtn.addEventListener('click', generateIdentifyTask);

        // ========== TAB 3: ÃœBEN ==========
        let practiceState = {
            score: 0,
            streak: 0,
            currentNumber: 0,
            correctAnswer: 0,
            level: 'ganzzahl',
            actualLevel: 'ganzzahl',
            answered: false,
            initialized: false,
            showMarkers: false
        };

        const practiceNumberDisplay = document.getElementById('practice-number-display');
        const practiceLabelRow = document.getElementById('practice-label-row');
        const practiceTargetPlace = document.getElementById('practice-target-place');
        const practiceAnswerInput = document.getElementById('practice-answer');
        const practiceCheckBtn = document.getElementById('practice-check-btn');
        const practiceFeedback = document.getElementById('practice-feedback');
        const practiceScoreDisplay = document.getElementById('practice-score');
        const practiceStreakDisplay = document.getElementById('practice-streak');
        const practiceStreakFire = document.getElementById('practice-streak-display');
        const practiceSkipBtn = document.getElementById('practice-skip-btn');
        const practiceNextBtn = document.getElementById('practice-next-btn');
        const practiceLegend = document.getElementById('practice-legend');
        const levelBtns = document.querySelectorAll('.level-btn');
        const practiceShowMarkersCheckbox = document.getElementById('practice-show-markers');
        const practiceShowLabelsCheckbox = document.getElementById('practice-show-labels');
        const helpBtn = document.getElementById('help-btn');
        const popupOverlay = document.getElementById('popup-overlay');
        const popupClose = document.getElementById('popup-close');

        helpBtn.addEventListener('click', () => {
            popupOverlay.classList.add('visible');
        });

        popupClose.addEventListener('click', () => {
            popupOverlay.classList.remove('visible');
        });

        popupOverlay.addEventListener('click', (e) => {
            if (e.target === popupOverlay) {
                popupOverlay.classList.remove('visible');
            }
        });

        practiceShowMarkersCheckbox.addEventListener('change', () => {
            practiceState.showMarkers = practiceShowMarkersCheckbox.checked;
            practiceLegend.style.display = practiceState.showMarkers ? 'flex' : 'none';
            // Re-display current number with/without markers
            if (practiceState.currentNumber) {
                displayPracticeNumber(practiceState.currentNumber, practiceState.actualLevel);
                practiceLabelRow.style.display = practiceShowLabelsCheckbox.checked ? 'flex' : 'none';
            }
        });

        practiceShowLabelsCheckbox.addEventListener('change', () => {
            practiceLabelRow.style.display = practiceShowLabelsCheckbox.checked ? 'flex' : 'none';
        });

        levelBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                levelBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                practiceState.level = btn.dataset.level;
                generatePracticeTask();
            });
        });

        function displayPracticeNumber(number, level) {
            practiceNumberDisplay.innerHTML = '';
            practiceLabelRow.innerHTML = '';
            
            const numStr = number.toString();
            const parts = numStr.split('.');
            const intPart = parts[0];
            const decPart = parts[1] || '';
            
            const labels = ['Hunderter', 'Zehner', 'Einer', '', 'Zehntel', 'Hundertstel', 'Tausendstel', 'Zehn-<br>tausendstel', 'Hundert-<br>tausendstel'];
            
            const allDigits = [];
            for (let i = 0; i < intPart.length; i++) {
                allDigits.push({
                    digit: intPart[i],
                    label: labels[3 - intPart.length + i] || ''
                });
            }
            if (decPart) {
                allDigits.push({ digit: ',', isDecimal: true, label: '' });
                for (let i = 0; i < decPart.length; i++) {
                    allDigits.push({
                        digit: decPart[i],
                        label: labels[4 + i] || ''
                    });
                }
            }

            const { targetIdx, decisionIdx } = getTargetAndDecisionIndex(level, intPart.length);

            allDigits.forEach((item, idx) => {
                const box = document.createElement('div');
                box.className = 'digit-box';
                
                if (item.isDecimal) {
                    box.classList.add('decimal');
                    box.textContent = ',';
                } else {
                    box.textContent = item.digit;
                    
                    if (practiceState.showMarkers) {
                        if (idx === targetIdx) {
                            box.classList.add('target');
                            const arrow = document.createElement('div');
                            arrow.className = 'arrow-indicator';
                            arrow.textContent = 'â–¼ Ziel';
                            box.appendChild(arrow);
                        }
                        
                        if (idx === decisionIdx) {
                            box.classList.add('decision');
                        }
                    }
                }
                
                practiceNumberDisplay.appendChild(box);
                
                const labelCell = document.createElement('div');
                labelCell.className = 'label-cell';
                if (item.isDecimal) {
                    labelCell.classList.add('decimal');
                }
                labelCell.innerHTML = item.label;
                practiceLabelRow.appendChild(labelCell);
            });
        }

        function generatePracticeTask() {
            practiceState.answered = false;
            practiceAnswerInput.value = '';
            practiceAnswerInput.className = 'answer-input';
            practiceFeedback.textContent = '';
            practiceFeedback.className = 'feedback';
            practiceSkipBtn.style.display = 'inline-block';
            practiceNextBtn.style.display = 'none';
            practiceCheckBtn.disabled = false;
            practiceAnswerInput.disabled = false;

            let actualLevel = practiceState.level;
            
            if (practiceState.level === 'gemischt') {
                actualLevel = getRandomLevel();
            }

            const levelConfig = levels[actualLevel];
            practiceState.currentNumber = levelConfig.generate();
            practiceState.correctAnswer = levelConfig.round(practiceState.currentNumber);
            practiceState.actualLevel = actualLevel;
            
            // Random formulation
            const displayName = getRandomAltName(actualLevel);
            practiceTargetPlace.textContent = displayName;
            
            displayPracticeNumber(practiceState.currentNumber, actualLevel);
            practiceLabelRow.style.display = practiceShowLabelsCheckbox.checked ? 'flex' : 'none';
            practiceAnswerInput.focus();
        }

        function formatAnswer(num, level) {
            const decimals = levels[level].decimals;
            if (decimals > 0) {
                return num.toFixed(decimals).replace('.', ',');
            }
            return num.toString().replace('.', ',');
        }

        function checkPracticeAnswer() {
            if (practiceState.answered) return;
            
            const userAnswer = parseFloat(practiceAnswerInput.value.replace(',', '.'));
            
            if (isNaN(userAnswer)) {
                practiceFeedback.textContent = 'Bitte gib eine Zahl ein.';
                practiceFeedback.className = 'feedback';
                return;
            }

            practiceState.answered = true;
            practiceCheckBtn.disabled = true;
            practiceAnswerInput.disabled = true;
            practiceSkipBtn.style.display = 'none';
            practiceNextBtn.style.display = 'inline-block';

            const isCorrect = Math.abs(userAnswer - practiceState.correctAnswer) < 0.00001;

            if (isCorrect) {
                practiceState.streak++;
                const bonus = practiceState.streak >= 3 ? practiceState.streak : 0;
                practiceState.score += 10 + bonus;
                
                practiceAnswerInput.className = 'answer-input correct';
                
                let msg = ['Richtig!', 'Super!', 'Perfekt!', 'Genau!'][Math.floor(Math.random() * 4)];
                if (practiceState.streak >= 3) {
                    msg += ` (+${bonus} Bonus)`;
                }
                practiceFeedback.textContent = msg;
                practiceFeedback.className = 'feedback correct';
                
                practiceStreakFire.style.display = practiceState.streak >= 3 ? 'inline' : 'none';
                
                // Auto-advance after 2 seconds
                setTimeout(() => {
                    if (practiceState.answered) {
                        generatePracticeTask();
                    }
                }, 2000);
            } else {
                practiceState.streak = 0;
                practiceStreakFire.style.display = 'none';
                
                practiceAnswerInput.className = 'answer-input wrong';
                
                const correctStr = formatAnswer(practiceState.correctAnswer, practiceState.actualLevel);
                practiceFeedback.innerHTML = `Leider falsch. Richtig: <span class="correct-answer">${correctStr}</span>`;
                practiceFeedback.className = 'feedback wrong';
            }

            updatePracticeDisplay();
        }

        function updatePracticeDisplay() {
            practiceScoreDisplay.textContent = practiceState.score;
            practiceStreakDisplay.textContent = practiceState.streak;
        }

        practiceCheckBtn.addEventListener('click', checkPracticeAnswer);
        
        practiceAnswerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (practiceState.answered) {
                    generatePracticeTask();
                } else {
                    checkPracticeAnswer();
                }
            }
        });

        practiceSkipBtn.addEventListener('click', () => {
            practiceState.streak = 0;
            practiceStreakFire.style.display = 'none';
            updatePracticeDisplay();
            generatePracticeTask();
        });

        practiceNextBtn.addEventListener('click', generatePracticeTask);

        practiceAnswerInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9.,\-]/g, '');
        });

        // ========== TAB 4: PRÃœFUNG ==========
        const examState = {
            tasks: [],
            currentTask: 0,
            answers: [],
            timerInterval: null,
            timeRemaining: 120, // 2 minutes in seconds
            started: false
        };

        const examStartScreen = document.getElementById('exam-start');
        const examActiveScreen = document.getElementById('exam-active');
        const examResultsScreen = document.getElementById('exam-results');
        const examStartBtn = document.getElementById('exam-start-btn');
        const examRestartBtn = document.getElementById('exam-restart-btn');
        const examCurrentDisplay = document.getElementById('exam-current');
        const examTimerDisplay = document.getElementById('exam-timer');
        const examNumberDisplay = document.getElementById('exam-number-display');
        const examTargetPlace = document.getElementById('exam-target-place');
        const examAnswerInput = document.getElementById('exam-answer');
        const examNextBtn = document.getElementById('exam-next-btn');
        const examCorrectDisplay = document.getElementById('exam-correct');
        const examPercentDisplay = document.getElementById('exam-percent');
        const examWrongSection = document.getElementById('exam-wrong-section');
        const examWrongList = document.getElementById('exam-wrong-list');

        function generateExamTasks() {
            examState.tasks = [];
            const allLevels = ['zehner', 'ganzzahl', 'zehntel', 'hundertstel', 'tausendstel'];
            
            for (let i = 0; i < 12; i++) {
                const level = allLevels[Math.floor(Math.random() * allLevels.length)];
                const levelConfig = levels[level];
                const number = levelConfig.generate();
                const correctAnswer = levelConfig.round(number);
                const displayName = getRandomAltName(level);
                
                examState.tasks.push({
                    number,
                    level,
                    displayName,
                    correctAnswer
                });
            }
        }

        function displayExamNumber(number) {
            examNumberDisplay.innerHTML = '';
            
            const numStr = number.toString();
            const parts = numStr.split('.');
            const intPart = parts[0];
            const decPart = parts[1] || '';
            
            for (let i = 0; i < intPart.length; i++) {
                const box = document.createElement('div');
                box.className = 'digit-box';
                box.textContent = intPart[i];
                examNumberDisplay.appendChild(box);
            }
            
            if (decPart) {
                const decBox = document.createElement('div');
                decBox.className = 'digit-box decimal';
                decBox.textContent = ',';
                examNumberDisplay.appendChild(decBox);
                
                for (let i = 0; i < decPart.length; i++) {
                    const box = document.createElement('div');
                    box.className = 'digit-box';
                    box.textContent = decPart[i];
                    examNumberDisplay.appendChild(box);
                }
            }
        }

        function showExamTask() {
            const task = examState.tasks[examState.currentTask];
            examCurrentDisplay.textContent = examState.currentTask + 1;
            examTargetPlace.textContent = task.displayName;
            displayExamNumber(task.number);
            examAnswerInput.value = '';
            examAnswerInput.focus();
        }

        function updateTimer() {
            examState.timeRemaining--;
            
            const minutes = Math.floor(examState.timeRemaining / 60);
            const seconds = examState.timeRemaining % 60;
            examTimerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (examState.timeRemaining <= 60) {
                examTimerDisplay.classList.add('warning');
            }
            
            if (examState.timeRemaining <= 0) {
                endExam();
            }
        }

        function startExam() {
            generateExamTasks();
            examState.currentTask = 0;
            examState.answers = [];
            examState.timeRemaining = 120;
            examState.started = true;
            
            examTimerDisplay.textContent = '2:00';
            examTimerDisplay.classList.remove('warning');
            
            examStartScreen.style.display = 'none';
            examResultsScreen.style.display = 'none';
            examActiveScreen.style.display = 'block';
            
            showExamTask();
            
            examState.timerInterval = setInterval(updateTimer, 1000);
        }

        function submitExamAnswer() {
            const userAnswer = examAnswerInput.value.trim();
            examState.answers.push(userAnswer);
            
            examState.currentTask++;
            
            if (examState.currentTask >= 12) {
                endExam();
            } else {
                showExamTask();
            }
        }

        function endExam() {
            clearInterval(examState.timerInterval);
            examState.started = false;
            
            examActiveScreen.style.display = 'none';
            examResultsScreen.style.display = 'block';
            
            // Calculate results
            let correct = 0;
            const wrongAnswers = [];
            
            examState.tasks.forEach((task, idx) => {
                const userAnswer = parseFloat(examState.answers[idx]?.replace(',', '.') || 'NaN');
                const isCorrect = Math.abs(userAnswer - task.correctAnswer) < 0.00001;
                
                if (isCorrect) {
                    correct++;
                } else {
                    wrongAnswers.push({
                        number: task.number,
                        displayName: task.displayName,
                        level: task.level,
                        userAnswer: examState.answers[idx] || 'â€“',
                        correctAnswer: formatAnswer(task.correctAnswer, task.level)
                    });
                }
            });
            
            const percent = Math.round((correct / 12) * 100);
            
            examCorrectDisplay.textContent = correct;
            examPercentDisplay.textContent = `${percent}%`;
            
            // Show wrong answers
            if (wrongAnswers.length > 0) {
                examWrongSection.style.display = 'block';
                examWrongList.innerHTML = '';
                
                wrongAnswers.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'exam-wrong-item';
                    div.innerHTML = `
                        <div class="task">${item.number.toString().replace('.', ',')} auf ${item.displayName}</div>
                        <div class="answers">
                            <span class="your-answer">Deine Antwort: ${item.userAnswer}</span>
                            <span class="correct-answer">Richtig: ${item.correctAnswer}</span>
                        </div>
                    `;
                    examWrongList.appendChild(div);
                });
            } else {
                examWrongSection.style.display = 'none';
            }
        }

        examStartBtn.addEventListener('click', startExam);
        examRestartBtn.addEventListener('click', () => {
            examResultsScreen.style.display = 'none';
            examStartScreen.style.display = 'block';
        });
        
        examNextBtn.addEventListener('click', submitExamAnswer);
        
        examAnswerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && examState.started) {
                submitExamAnswer();
            }
        });
        
        examAnswerInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9.,\-]/g, '');
        });
    </script>
</body>
</html>
